---
export const prerender = false;
import { getCollection, getEntry, type CollectionEntry } from 'astro:content';
import LogEntryLayout from '../layouts/LogEntryLayout.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import NotFoundContent from '../components/NotFoundContent.astro';

const { slug } = Astro.params;

let entry: CollectionEntry<'log'> | undefined;
let ContentComponent: any;

// Block internal helper page from being routable
if (typeof slug === 'string' && slug.toLowerCase() === 'claude') {
  Astro.response.status = 404;
}

if (slug) {
  try {
    entry = await getEntry('log', slug);
  } catch (e) {
    console.error(`Error fetching entry for slug "${slug}":`, e);
    entry = undefined;
  }
}

if (entry) {
  const rendered = await entry.render();
  ContentComponent = rendered.Content;
} else {
  // For unknown slugs, mark response as 404
  Astro.response.status = 404;
}
---
{entry && ContentComponent ? (
  <LogEntryLayout frontmatter={entry.data}>
    <ContentComponent />
  </LogEntryLayout>
) : (
  <BaseLayout title="404 - nibzard" description="File not found. Try Home, Log, or Search.">
    <NotFoundContent slug={slug} />
  </BaseLayout>
)}
